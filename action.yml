name: 'GAWG Build action'
description: 'This action checks the technology used in the project (Python or Node.js), performs a build operation, and then uploads the resulting build artifacts. The artifacts are retained for a specified number of days. This action is useful for continuous integration workflows where you want to build your project and store the build output for later use or deployment.'
author: Álvaro García Pizarro
branding:
  icon: 'cpu'
  color: 'gray-dark'

inputs:
  technology:
    type: string
    description: 'Technology to use for the build. Avaliable options: maven, python, node.'
    required: true

  config-json:
    type: string
    description: 'JSON string containing workflow config parameters.'
    required: true

outputs:
  ARTIFACT_NAME:
    description: 'Name of the artifact generated by the build.'
    value: ${{ steps.artifact-name.outputs.ARTIFACT_NAME }}

runs:
  using: "composite"
  steps:
    - name: Validate technology
      shell: bash
      run: |
        TECHNOLOGIES=("python" "node" "maven")
        if [[ " ${TECHNOLOGIES[@]} " =~ " ${{ inputs.technology }} " ]]; then
          echo "✅ ${{ inputs.technology }} is a valid technology."
        else
          echo "❌ Error: ${{ inputs.technology }} is not a valid technology."
          echo "::error:: ❌ Error: ${{ inputs.technology }} is not a valid technology."
          exit 1
        fi

    - name: Generate artifact name
      shell: bash
      id: artifact-name
      run: |
        echo "Generating artifact name..."
        echo "ARTIFACT_NAME is: $(echo ${{ fromJson(inputs.config-json).PROJECT_NAME }}-${{ inputs.technology }}-$(date +'%Y%m%d%H%M%S'))"
        echo "ARTIFACT_NAME=$(echo ${{ fromJson(inputs.config-json).PROJECT_NAME }}-${{ inputs.technology }}-$(date +'%Y%m%d%H%M%S'))" >> $GITHUB_OUTPUT

    - name: Set-up JAVA environment
      if: ${{ inputs.technology == 'maven' }}
      uses: actions/setup-java@v4
      with:
        distribution: ${{ fromJson(inputs.config-json).JAVA_DISTRIBUTION }} # VALIDAR
        java-version: ${{ fromJson(inputs.config-json).JAVA_VERSION }} # VALIDAR

    - name: Build maven project
      id: build-maven
      if: ${{ inputs.technology == 'maven' }}
      shell: bash
      run: |
        echo "Building maven project..."
        mvn clean install

    - name: Create JAVA artifact
      if: ${{ inputs.technology == 'maven' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact-name.outputs.ARTIFACT_NAME }}
        retention-days: ${{ fromJson(inputs.config-json).RETENTION_DAYS }}
        overwrite: true
        path: ${{ fromJson(inputs.config-json).JAVA_DIST_DIR }}

    - name: Set-up Python environment
      if: ${{ inputs.technology == 'python' }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ fromJson(inputs.config-json).PYTHON_VERSION }} # VALIDAR

    - name: Build python project
      id: build-python
      if: ${{ inputs.technology == 'python' }}
      shell: bash
      run: |
        echo "Building python project..."
        python3 -m pip install -r requirements.txt

    - name: Create Python artifact
      if: ${{ inputs.technology == 'python' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact-name.outputs.ARTIFACT_NAME }}
        retention-days: ${{ fromJson(inputs.config-json).RETENTION_DAYS }}
        overwrite: true
        path: ${{ fromJson(inputs.config-json).PYTHON_DIST_DIR }}

    - name: test node variables
      if: ${{ inputs.technology == 'node' }}
      run: |
        echo "NODE_VERSION: ${{ fromJson(inputs.config-json).NODE_VERSION }}"
        echo "NODE_DIST_DIR: ${{ fromJson(inputs.config-json).NODE_DIST_DIR }}"
        echo "RETENTION_DAYS: ${{ fromJson(inputs.config-json).RETENTION_DAYS }}"

    - name: Set-up Node environment
      if: ${{ inputs.technology == 'node' }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ fromJson(inputs.config-json).NODE_VERSION }} # VALIDAR

    - name: Build node project
      id: build-node
      if: ${{ inputs.technology == 'node' }}
      shell: bash
      run: |
        echo "Building node project..."
        npm install
        npm run build

    - name: Create Node artifact
      if: ${{ inputs.technology == 'node' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact-name.outputs.ARTIFACT_NAME }}
        retention-days: ${{ fromJson(inputs.config-json).RETENTION_DAYS }}
        overwrite: true
        path: ${{ fromJson(inputs.config-json).NODE_DIST_DIR }}